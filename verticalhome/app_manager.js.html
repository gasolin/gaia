<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app_manager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app_manager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global ConfirmDialogHelper */
/* global BookmarksDatabase */
/* global CollectionsDatabase */

'use strict';

(function(exports) {

  function AppManager() {
    var grid = document.querySelector('gaia-grid');
    var self = this;
    navigator.mozApps.getSelf().onsuccess = function(evt) {
      self.app = evt.target.result;
      window.dispatchEvent(new CustomEvent('appmanager-ready'));
    };

    window.addEventListener('gaiagrid-add-to-collection', this);
    grid.addEventListener('removeitem', this);
  }

  AppManager.prototype = {
    dialogVisible: false,

    get self() {
      return this.app;
    },

    /**
    Handles the asyncrhonous removal of items on the grid after the DOM element
    has been removed.
    */
    handleItemRemoval: function(item) {
      function errorLogger(err) {
        console.error('Error while trying to remove', item.name, err);
      }

      switch (item.detail.type) {
        case 'bookmark':
          BookmarksDatabase.remove(item.identifier).catch(errorLogger);
          break;
        case 'collection':
          CollectionsDatabase.remove(item.identifier).catch(errorLogger);
          break;
        default:
          console.error(
            'Cannot handle remove for item type ',
            item.detail.type
          );
      }
    },

    /**
     * General event handler.
     */
    handleEvent: function(e) {
      var nameObj = {
        name: e.detail &amp;&amp; e.detail.name
      };

      switch(e.type) {
        case 'removeitem':
          if (this.dialogVisible) {
            return;
          }

          this.dialogVisible = true;
          if (e.detail.detail.type == 'app') {
            var request = navigator.mozApps.mgmt.uninstall(e.detail.app);
            request.onsuccess = () => {
              e.detail.removeFromGrid();
              this.dialogVisible = false;
            };
            request.onerror = () => {
              console.error('Error while trying to remove',
                            e.detail.name, request.error);
              this.dialogVisible = false;
            };
            break;
          }
          var dialog = new ConfirmDialogHelper({
            type: 'remove',
            title: {id: 'delete-title', args: nameObj},
            body: {id: 'delete-body', args: nameObj},
            cancel: {
              title: 'cancel',
              cb: () => {
                this.dialogVisible = false;
              }
            },
            confirm: {
              title: 'delete',
              type: 'danger',
              cb: () => {
                // immediately remove item from the grid!
                e.detail.removeFromGrid();

                // handle the real removal asynchronously
                this.handleItemRemoval(e.detail);

                this.dialogVisible = false;
              }
            }
          });
          dialog.show(document.body);
          break;

        case 'gaiagrid-add-to-collection':
          this.sendEventToCollectionApp('add-to-collection', e.detail);
          break;
      }
    },

    sendEventToCollectionApp: function(eventName, message) {
      var onAppReady = function(app) {
        app.connect(eventName).then(
          function onConnectionAccepted(ports) {
            ports.forEach(function(port) {
              port.postMessage(message);
            });
          }, function onConnectionRejected() {
            console.error('Cannot connect to collection app');
          }
        );
      };

      if (!this.app) {
        window.addEventListener('appmanager-ready', function onReady() {
          window.removeEventListener('appmanager-ready', onReady);
          onAppReady(this.app);
        }.bind(this));
      } else {
        onAppReady(this.app);
      }
    },
  };

  exports.appManager = new AppManager();

}(window));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Mon Jun 08 2015 10:22:02 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
